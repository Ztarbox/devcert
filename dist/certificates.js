"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const createDebug = require("debug");
const fs_1 = require("fs");
const mkdirp_1 = require("mkdirp");
const certificate_authority_1 = require("./certificate-authority");
const constants_1 = require("./constants");
const utils_1 = require("./utils");
const debug = createDebug('devcert:certificates');
/**
 * Generate a domain certificate signed by the devcert root CA. Domain
 * certificates are cached in their own directories under
 * CONFIG_ROOT/domains/<domain>, and reused on subsequent requests. Because the
 * individual domain certificates are signed by the devcert root CA (which was
 * added to the OS/browser trust stores), they are trusted.
 */
async function generateDomainCertificate(commonName, alternativeNames, certOptions) {
    mkdirp_1.sync(utils_1.pathForDomain(commonName));
    debug(`Generating private key for ${commonName}`);
    const domainKeyPath = utils_1.pathForDomain(commonName, 'private-key.key');
    generateKey(domainKeyPath);
    debug(`Generating certificate signing request for ${commonName}`);
    const csrFile = utils_1.pathForDomain(commonName, `certificate-signing-request.csr`);
    await constants_1.withDomainSigningRequestConfig(commonName, { alternativeNames }, configpath => {
        utils_1.openssl(`req -new -config "${configpath}" -key "${domainKeyPath}" -out "${csrFile}" -days ${certOptions.domainCertExpiry}`, `generating CSR for ${commonName}`);
    });
    debug(`Generating certificate for ${commonName} from signing request and signing with root CA`);
    const domainCertPath = utils_1.pathForDomain(commonName, `certificate.crt`);
    await certificate_authority_1.withCertificateAuthorityCredentials(async ({ caKeyPath, caCertPath }) => {
        await constants_1.withDomainCertificateConfig(commonName, alternativeNames, domainCertConfigPath => {
            utils_1.openssl(`ca -config "${domainCertConfigPath}" -in "${csrFile}" -out "${domainCertPath}" -keyfile "${caKeyPath}" -cert "${caCertPath}" -days ${certOptions.domainCertExpiry} -batch`, `signing cert for ${commonName} with root ca`);
        });
    });
}
exports.generateDomainCertificate = generateDomainCertificate;
function isFile(pth) {
    return fs_1.statSync(pth).isFile();
}
/**
 * Revokes a domain certificate signed by the devcert root CA and deletes it.
 */
async function revokeDomainCertificate(commonName) {
    debug(`Revoking certificate for ${commonName}`);
    const domainCertPath = utils_1.certPathForDomain(commonName);
    assert(fs_1.existsSync(domainCertPath), 'domainCertPath must exist');
    assert(isFile(domainCertPath), 'domainCertPath must be a file');
    debug('domainCertPath', domainCertPath);
    assert(fs_1.readFileSync(domainCertPath).toString().length > 0, 'domainCert must be non-empty');
    await certificate_authority_1.withCertificateAuthorityCredentials(async ({ caKeyPath, caCertPath }) => {
        debug('caKeyPath', caKeyPath);
        debug('caCertPath', caCertPath);
        assert(fs_1.existsSync(caCertPath), 'ca cert must exist');
        assert(isFile(caCertPath), 'ca cert must be a file');
        assert(fs_1.existsSync(caKeyPath), 'ca key must exist');
        assert(isFile(caKeyPath), 'ca key must be a file');
        await constants_1.withDomainCertificateConfig(commonName, [], domainCertConfigPath => {
            assert(fs_1.existsSync(domainCertConfigPath), 'domainCertConfigPath must exist');
            assert(isFile(domainCertConfigPath), 'domainCertConfigPath must be a file');
            utils_1.openssl(`ca -config "${domainCertConfigPath}" -revoke "${domainCertPath}" -keyfile "${caKeyPath}" -cert "${caCertPath}"`, `revoking domain certificate for ${commonName}`);
        });
    }).catch(err => {
        throw new Error(`Problem revoking certificate\n${err}`);
    });
}
exports.revokeDomainCertificate = revokeDomainCertificate;
// Generate a cryptographic key, used to sign certificates or certificate signing requests.
function generateKey(filename) {
    debug(`generateKey: ${filename}`);
    utils_1.openssl(`genrsa -out "${filename}" 2048`, 'generating RSA key');
    fs_1.chmodSync(filename, 400);
}
exports.generateKey = generateKey;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VydGlmaWNhdGVzLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJjZXJ0aWZpY2F0ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBaUM7QUFDakMscUNBQXFDO0FBQ3JDLDJCQUE0RTtBQUM1RSxtQ0FBd0M7QUFDeEMsbUVBQThFO0FBQzlFLDJDQUdxQjtBQUVyQixtQ0FBb0U7QUFFcEUsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFFbEQ7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLHlCQUF5QixDQUM3QyxVQUFrQixFQUNsQixnQkFBMEIsRUFDMUIsV0FBd0I7SUFFeEIsYUFBTSxDQUFDLHFCQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUVsQyxLQUFLLENBQUMsOEJBQThCLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDbEQsTUFBTSxhQUFhLEdBQUcscUJBQWEsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztJQUNuRSxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7SUFFM0IsS0FBSyxDQUFDLDhDQUE4QyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQ2xFLE1BQU0sT0FBTyxHQUFHLHFCQUFhLENBQUMsVUFBVSxFQUFFLGlDQUFpQyxDQUFDLENBQUM7SUFDN0UsTUFBTSwwQ0FBOEIsQ0FDbEMsVUFBVSxFQUNWLEVBQUUsZ0JBQWdCLEVBQUUsRUFDcEIsVUFBVSxDQUFDLEVBQUU7UUFDWCxlQUFPLENBQ0wscUJBQXFCLFVBQVUsV0FBVyxhQUFhLFdBQVcsT0FBTyxXQUFXLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUNsSCxzQkFBc0IsVUFBVSxFQUFFLENBQ25DLENBQUM7SUFDSixDQUFDLENBQ0YsQ0FBQztJQUVGLEtBQUssQ0FDSCw4QkFBOEIsVUFBVSxnREFBZ0QsQ0FDekYsQ0FBQztJQUNGLE1BQU0sY0FBYyxHQUFHLHFCQUFhLENBQUMsVUFBVSxFQUFFLGlCQUFpQixD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QUFHLENBQUMsQ0FBQztBQUN2QixDQUFDO0FBSkQsa0NBSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSAnYXNzZXJ0JztcclxuaW1wb3J0ICogYXMgY3JlYXRlRGVidWcgZnJvbSAnZGVidWcnO1xyXG5pbXBvcnQgeyBjaG1vZFN5bmMgYXMgY2htb2QsIGV4aXN0c1N5bmMsIHN0YXRTeW5jLCByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XHJcbmltcG9ydCB7IHN5bmMgYXMgbWtkaXJwIH0gZnJvbSAnbWtkaXJwJztcclxuaW1wb3J0IHsgd2l0aENlcnRpZmljYXRlQXV0aG9yaXR5Q3JlZGVudGlhbHMgfSBmcm9tICcuL2NlcnRpZmljYXRlLWF1dGhvcml0eSc7XHJcbmltcG9ydCB7XHJcbiAgd2l0aERvbWFpbkNlcnRpZmljYXRlQ29uZmlnLFxyXG4gIHdpdGhEb21haW5TaWduaW5nUmVxdWVzdENvbmZpZ1xyXG59IGZyb20gJy4vY29uc3RhbnRzJztcclxuaW1wb3J0IHsgQ2VydE9wdGlvbnMgfSBmcm9tICcuL2luZGV4JztcclxuaW1wb3J0IHsgb3BlbnNzbCwgcGF0aEZvckRvbWFpbiwgY2VydFBhdGhGb3JEb21haW4gfSBmcm9tICcuL3V0aWxzJztcclxuXHJcbmNvbnN0IGRlYnVnID0gY3JlYXRlRGVidWcoJ2RldmNlcnQ6Y2VydGlmaWNhdGVzJyk7XHJcblxyXG4vKipcclxuICogR2VuZXJhdGUgYSBkb21haW4gY2VydGlmaWNhdGUgc2lnbmVkIGJ5IHRoZSBkZXZjZXJ0IHJvb3QgQ0EuIERvbWFpblxyXG4gKiBjZXJ0aWZpY2F0ZXMgYXJlIGNhY2hlZCBpbiB0aGVpciBvd24gZGlyZWN0b3JpZXMgdW5kZXJcclxuICogQ09ORklHX1JPT1QvZG9tYWlucy88ZG9tYWluPiwgYW5kIHJldXNlZCBvbiBzdWJzZXF1ZW50IHJlcXVlc3RzLiBCZWNhdXNlIHRoZVxyXG4gKiBpbmRpdmlkdWFsIGRvbWFpbiBjZXJ0aWZpY2F0ZXMgYXJlIHNpZ25lZCBieSB0aGUgZGV2Y2VydCByb290IENBICh3aGljaCB3YXNcclxuICogYWRkZWQgdG8gdGhlIE9TL2Jyb3dzZXIgdHJ1c3Qgc3RvcmVzKSwgdGhleSBhcmUgdHJ1c3RlZC5cclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZW5lcmF0ZURvbWFpbkNlcnRpZmljYXRlKFxyXG4gIGNvbW1vbk5hbWU6IHN0cmluZyxcclxuICBhbHRlcm5hdGl2ZU5hbWVzOiBzdHJpbmdbXSxcclxuICBjZXJ0T3B0aW9uczogQ2VydE9wdGlvbnNcclxuKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgbWtkaXJwKHBhdGhGb3JEb21haW4oY29tbW9uTmFtZSkpO1xyXG5cclxuICBkZWJ1ZyhgR2VuZXJhdGluZyBwcml2YXRlIGtleSBmb3IgJHtjb21tb25OYW1lfWApO1xyXG4gIGNvbnN0IGRvbWFpbktleVBhdGggPSBwYXRoRm9yRG9tYWluKGNvbW1vbk5hbWUsICdwcml2YXRlLWtleS5rZXknKTtcclxuICBnZW5lcmF0ZUtleShkb21haW5LZXlQYXRoKTtcclxuXHJcbiAgZGVidWcoYEdlbmVyYXRpbmcgY2VydGlmaWNhdGUgc2lnbmluZyByZXF1ZXN0IGZvciAke2NvbW1vbk5hbWV9YCk7XHJcbiAgY29uc3QgY3NyRmlsZSA9IHBhdGhGb3JEb21haW4oY29tbW9uTmFtZSwgYGNlcnRpZmljYXRlLXNpZ25pbmctcmVxdWVzdC5jc3JgKTtcclxuICBhd2FpdCB3aXRoRG9tYWluU2lnbmluZ1JlcXVlc3RDb25maWcoXHJcbiAgICBjb21tb25OYW1lLFxyXG4gICAgeyBhbHRlcm5hdGl2ZU5hbWVzIH0sXHJcbiAgICBjb25maWdwYXRoID0+IHtcclxuICAgICAgb3BlbnNzbChcclxuICAgICAgICBgcmVxIC1uZXcgLWNvbmZpZyBcIiR7Y29uZmlncGF0aH1cIiAta2V5IFwiJHtkb21haW5LZXlQYXRofVwiIC1vdXQgXCIke2NzckZpbGV9XCIgLWRheXMgJHtjZXJ0T3B0aW9ucy5kb21haW5DZXJ0RXhwaXJ5fWAsXHJcbiAgICAgICAgYGdlbmVyYXRpbmcgQ1NSIGZvciAke2NvbW1vbk5hbWV9YFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICk7XHJcblxyXG4gIGRlYnVnKFxyXG4gICAgYEdlbmVyYXRpbmcgY2VydGlmaWNhdGUgZm9yICR7Y29tbW9uTmFtZX0gZnJvbSBzaWduaW5nIHJlcXVlc3QgYW5kIHNpZ25pbmcgd2l0aCByb290IENBYFxyXG4gICk7XHJcbiAgY29uc3QgZG9tYWluQ2VydFBhdGggPSBwYXRoRm9yRG9tYWluKGNvbW1vbk5hbWUsIGBjZXJ0aWZpY2F0ZS5jcnRgKTtcclxuXHJcbiAgYXdhaXQgd2l0aENlcnRpZmljYXRlQXV0aG9yaXR5Q3JlZGVudGlhbHMoXHJcbiAgICBhc3luYyAoeyBjYUtleVBhdGgsIGNhQ2VydFBhdGggfSkgPT4ge1xyXG4gICAgICBhd2FpdCB3aXRoRG9tYWluQ2VydGlmaWNhdGVDb25maWcoXHJcbiAgICAgICAgY29tbW9uTmFtZSxcclxuICAgICAgICBhbHRlcm5hdGl2ZU5hbWVzLFxyXG4gICAgICAgIGRvbWFpbkNlcnRDb25maWdQYXRoID0+IHtcclxuICAgICAgICAgIG9wZW5zc2woXHJcbiAgICAgICAgICAgIGBjYSAtY29uZmlnIFwiJHtkb21haW5DZXJ0Q29uZmlnUGF0aH1cIiAtaW4gXCIke2NzckZpbGV9XCIgLW91dCBcIiR7ZG9tYWluQ2VydFBhdGh9XCIgLWtleWZpbGUgXCIke2NhS2V5UGF0aH1cIiAtY2VydCBcIiR7Y2FDZXJ0UGF0aH1cIiAtZGF5cyAke2NlcnRPcHRpb25zLmRvbWFpbkNlcnRFeHBpcnl9IC1iYXRjaGAsXHJcbiAgICAgICAgICAgIGBzaWduaW5nIGNlcnQgZm9yICR7Y29tbW9uTmFtZX0gd2l0aCByb290IGNhYFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNGaWxlKHB0aDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgcmV0dXJuIHN0YXRTeW5jKHB0aCkuaXNGaWxlKCk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBSZXZva2VzIGEgZG9tYWluIGNlcnRpZmljYXRlIHNpZ25lZCBieSB0aGUgZGV2Y2VydCByb290IENBIGFuZCBkZWxldGVzIGl0LlxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJldm9rZURvbWFpbkNlcnRpZmljYXRlKFxyXG4gIGNvbW1vbk5hbWU6IHN0cmluZ1xyXG4pOiBQcm9taXNlPHZvaWQ+IHtcclxuICBkZWJ1ZyhgUmV2b2tpbmcgY2VydGlmaWNhdGUgZm9yICR7Y29tbW9uTmFtZX1gKTtcclxuICBjb25zdCBkb21haW5DZXJ0UGF0aCA9IGNlcnRQYXRoRm9yRG9tYWluKGNvbW1vbk5hbWUpO1xyXG4gIGFzc2VydChleGlzdHNTeW5jKGRvbWFpbkNlcnRQYXRoKSwgJ2RvbWFpbkNlcnRQYXRoIG11c3QgZXhpc3QnKTtcclxuICBhc3NlcnQoaXNGaWxlKGRvbWFpbkNlcnRQYXRoKSwgJ2RvbWFpbkNlcnRQYXRoIG11c3QgYmUgYSBmaWxlJyk7XHJcbiAgZGVidWcoJ2RvbWFpbkNlcnRQYXRoJywgZG9tYWluQ2VydFBhdGgpO1xyXG5cclxuICBhc3NlcnQoXHJcbiAgICByZWFkRmlsZVN5bmMoZG9tYWluQ2VydFBhdGgpLnRvU3RyaW5nKCkubGVuZ3RoID4gMCxcclxuICAgICdkb21haW5DZXJ0IG11c3QgYmUgbm9uLWVtcHR5J1xyXG4gICk7XHJcbiAgYXdhaXQgd2l0aENlcnRpZmljYXRlQXV0aG9yaXR5Q3JlZGVudGlhbHMoXHJcbiAgICBhc3luYyAoeyBjYUtleVBhdGgsIGNhQ2VydFBhdGggfSkgPT4ge1xyXG4gICAgICBkZWJ1ZygnY2FLZXlQYXRoJywgY2FLZXlQYXRoKTtcclxuICAgICAgZGVidWcoJ2NhQ2VydFBhdGgnLCBjYUNlcnRQYXRoKTtcclxuICAgICAgYXNzZXJ0KGV4aXN0c1N5bmMoY2FDZXJ0UGF0aCksICdjYSBjZXJ0IG11c3QgZXhpc3QnKTtcclxuICAgICAgYXNzZXJ0KGlzRmlsZShjYUNlcnRQYXRoKSwgJ2NhIGNlcnQgbXVzdCBiZSBhIGZpbGUnKTtcclxuICAgICAgYXNzZXJ0KGV4aXN0c1N5bmMoY2FLZXlQYXRoKSwgJ2NhIGtleSBtdXN0IGV4aXN0Jyk7XHJcbiAgICAgIGFzc2VydChpc0ZpbGUoY2FLZXlQYXRoKSwgJ2NhIGtleSBtdXN0IGJlIGEgZmlsZScpO1xyXG4gICAgICBhd2FpdCB3aXRoRG9tYWluQ2VydGlmaWNhdGVDb25maWcoXHJcbiAgICAgICAgY29tbW9uTmFtZSxcclxuICAgICAgICBbXSxcclxuICAgICAgICBkb21haW5DZXJ0Q29uZmlnUGF0aCA9PiB7XHJcbiAgICAgICAgICBhc3NlcnQoXHJcbiAgICAgICAgICAgIGV4aXN0c1N5bmMoZG9tYWluQ2VydENvbmZpZ1BhdGgpLFxyXG4gICAgICAgICAgICAnZG9tYWluQ2VydENvbmZpZ1BhdGggbXVzdCBleGlzdCdcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgICBhc3NlcnQoXHJcbiAgICAgICAgICAgIGlzRmlsZShkb21haW5DZXJ0Q29uZmlnUGF0aCksXHJcbiAgICAgICAgICAgICdkb21haW5DZXJ0Q29uZmlnUGF0aCBtdXN0IGJlIGEgZmlsZSdcclxuICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgb3BlbnNzbChcclxuICAgICAgICAgICAgYGNhIC1jb25maWcgXCIke2RvbWFpbkNlcnRDb25maWdQYXRofVwiIC1yZXZva2UgXCIke2RvbWFpbkNlcnRQYXRofVwiIC1rZXlmaWxlIFwiJHtjYUtleVBhdGh9XCIgLWNlcnQgXCIke2NhQ2VydFBhdGh9XCJgLFxyXG4gICAgICAgICAgICBgcmV2b2tpbmcgZG9tYWluIGNlcnRpZmljYXRlIGZvciAke2NvbW1vbk5hbWV9YFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgKS5jYXRjaChlcnIgPT4ge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKGBQcm9ibGVtIHJldm9raW5nIGNlcnRpZmljYXRlXFxuJHtlcnJ9YCk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbi8vIEdlbmVyYXRlIGEgY3J5cHRvZ3JhcGhpYyBrZXksIHVzZWQgdG8gc2lnbiBjZXJ0aWZpY2F0ZXMgb3IgY2VydGlmaWNhdGUgc2lnbmluZyByZXF1ZXN0cy5cclxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlS2V5KGZpbGVuYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICBkZWJ1ZyhgZ2VuZXJhdGVLZXk6ICR7ZmlsZW5hbWV9YCk7XHJcbiAgb3BlbnNzbChgZ2VucnNhIC1vdXQgXCIke2ZpbGVuYW1lfVwiIDIwNDhgLCAnZ2VuZXJhdGluZyBSU0Ega2V5Jyk7XHJcbiAgY2htb2QoZmlsZW5hbWUsIDQwMCk7XHJcbn1cclxuIl19